<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Integration - Text Highlighting</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        .test-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Integration - Text Highlighting</h1>
        
        <div class="controls-main">
            <textarea id="textInput" placeholder="Digite seu texto aqui...">Ol√°! Como voc√™ est√° hoje? Que bela manh√£!</textarea>
            <div class="text-display" id="textDisplay">
                <!-- Highlighted text will appear here during playback -->
            </div>
            <div class="controls-main-buttons">
                <button id="playPauseButton" class="test-button">üéµ Play</button>
                <button id="testHighlighter" class="test-button">üß™ Test Highlighter</button>
                <button id="checkModules" class="test-button">üìã Check Modules</button>
            </div>
        </div>
        
        <div id="testLog" class="test-log"></div>
        
        <div class="settings">
            <!-- UI controls will be dynamically generated here -->
        </div>
    </div>

    <!-- Load all modules in the correct order -->
    <script src="js/config.js"></script>
    <script src="js/grammar.js"></script>
    <script src="js/musical-grammar.js"></script>
    <script src="js/harmonic-engine.js"></script>
    <script src="js/phonetic-engine.js"></script>
    <script src="js/stress-analyzer.js"></script>
    <script src="js/prosodic-engine.js"></script>
    <script src="js/linguistic-integration.js"></script>
    <script src="js/text-highlighter.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/ui.js"></script>

    <script>
        // Test logging function
        function log(message, type = 'info') {
            const testLog = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `status ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            testLog.appendChild(logEntry);
            testLog.scrollTop = testLog.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Initialize
        let audioInitialized = false;
        let textDisplay = null;

        async function initializeSystem() {
            log('üöÄ Initializing system...', 'info');
            
            try {
                // Get text display element
                textDisplay = document.getElementById('textDisplay');
                if (!textDisplay) {
                    log('‚ùå Text display element not found', 'error');
                    return false;
                }
                log('‚úì Text display element found', 'success');

                // Initialize audio
                if (typeof Tone !== 'undefined') {
                    await Tone.start();
                    audioInitialized = true;
                    log('‚úì Audio (Tone.js) initialized', 'success');
                } else {
                    log('‚ùå Tone.js not available', 'error');
                }

                // Initialize text highlighter
                if (typeof TextHighlighter !== 'undefined') {
                    TextHighlighter.initialize(textDisplay);
                    log('‚úì TextHighlighter initialized', 'success');
                } else {
                    log('‚ùå TextHighlighter module not available', 'error');
                    return false;
                }

                // Initialize linguistic integration
                if (typeof LinguisticIntegration !== 'undefined') {
                    LinguisticIntegration.setAnalysisMode('COMPLETE');
                    LinguisticIntegration.setDialect('carioca');
                    log('‚úì LinguisticIntegration initialized', 'success');
                } else {
                    log('‚ùå LinguisticIntegration module not available', 'error');
                    return false;
                }

                log('üéâ System initialization complete!', 'success');
                return true;

            } catch (error) {
                log(`‚ùå Initialization error: ${error.message}`, 'error');
                return false;
            }
        }

        function checkModules() {
            log('üìã Checking available modules...', 'info');
            
            const modules = [
                'Tone', 'AppConfig', 'GrammarAnalyzer', 'MusicalGrammar',
                'HarmonicEngine', 'PhoneticEngine', 'StressAnalyzer',
                'ProsodicEngine', 'LinguisticIntegration', 'TextHighlighter',
                'AudioManager', 'UIModule'
            ];

            modules.forEach(module => {
                if (typeof window[module] !== 'undefined') {
                    log(`‚úì ${module} - Available`, 'success');
                } else {
                    log(`‚úó ${module} - Not found`, 'error');
                }
            });

            // Check text display
            const textDisplay = document.getElementById('textDisplay');
            if (textDisplay) {
                log(`‚úì Text display element - Found`, 'success');
                log(`  ‚Ä¢ Element ID: ${textDisplay.id}`, 'info');
                log(`  ‚Ä¢ Element classes: ${textDisplay.className}`, 'info');
                log(`  ‚Ä¢ Display style: ${textDisplay.style.display || 'default'}`, 'info');
            } else {
                log(`‚úó Text display element - Not found`, 'error');
            }
        }

        async function testHighlighter() {
            log('üß™ Testing text highlighter...', 'info');

            try {
                const text = document.getElementById('textInput').value;
                if (!text.trim()) {
                    log('‚ùå No text to highlight', 'error');
                    return;
                }

                if (!audioInitialized) {
                    await initializeSystem();
                }

                if (typeof TextHighlighter === 'undefined') {
                    log('‚ùå TextHighlighter not available', 'error');
                    return;
                }

                // Set highlight mode
                TextHighlighter.setHighlightMode('word');
                log('‚úì Highlight mode set to "word"', 'success');

                // Process text with linguistic integration
                if (typeof LinguisticIntegration !== 'undefined') {
                    const result = LinguisticIntegration.processText(text, 'pentatonic_major');
                    log(`‚úì Text processed: ${result.finalSequence?.length || 0} elements`, 'success');

                    // Prepare text for highlighting
                    TextHighlighter.prepareText(text, result);
                    log('‚úì Text prepared for highlighting', 'success');

                    // Show text display
                    if (textDisplay) {
                        textDisplay.style.display = 'block';
                        textDisplay.classList.add('active');
                        log('‚úì Text display activated', 'success');
                    }

                    // Test highlighting without audio
                    log('üé® Starting visual highlighting test...', 'info');
                    TextHighlighter.startHighlighting(result);
                    
                    // Stop after 5 seconds for demo
                    setTimeout(() => {
                        TextHighlighter.stopHighlighting();
                        textDisplay.style.display = 'none';
                        textDisplay.classList.remove('active');
                        log('‚úì Highlighting test completed', 'success');
                    }, 5000);

                } else {
                    log('‚ùå LinguisticIntegration not available for testing', 'error');
                }

            } catch (error) {
                log(`‚ùå Test error: ${error.message}`, 'error');
            }
        }

        async function testPlayback() {
            log('üéµ Testing enhanced playback...', 'info');

            try {
                const text = document.getElementById('textInput').value;
                if (!text.trim()) {
                    log('‚ùå No text to play', 'error');
                    return;
                }

                if (!audioInitialized) {
                    await initializeSystem();
                }

                // Use enhanced playback if available
                if (typeof AudioManager !== 'undefined' && 
                    typeof AudioManager.togglePlaybackWithHighlighting !== 'undefined') {
                    
                    const result = AudioManager.togglePlaybackWithHighlighting(
                        text, 'pentatonic_major', 'COMPLETE', 'word'
                    );
                    
                    log('‚úì Enhanced playback started', 'success');
                    
                } else {
                    log('‚ùå Enhanced playback not available', 'error');
                }

            } catch (error) {
                log(`‚ùå Playback error: ${error.message}`, 'error');
            }
        }

        // Event listeners
        document.getElementById('checkModules').addEventListener('click', checkModules);
        document.getElementById('testHighlighter').addEventListener('click', testHighlighter);
        document.getElementById('playPauseButton').addEventListener('click', testPlayback);

        // Initialize on first user interaction
        document.addEventListener('click', async () => {
            if (!audioInitialized) {
                await initializeSystem();
            }
        }, { once: true });

        // Initial module check
        log('üîç Initial system check...', 'info');
        checkModules();
    </script>
</body>
</html>